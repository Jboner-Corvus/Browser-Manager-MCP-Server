import{randomUUID as e}from"crypto";import{FastMCP as r}from"fastmcp";import{config as t}from"./config.js";import o from"./logger.js";import{launchBrowserTool as s,listBrowsersTool as a,detectOpenBrowsersTool as i,connectExternalBrowserTool as n,closeBrowserTool as c,listTabsTool as l,selectTabTool as p,newTabTool as d,closeTabTool as u,navigateTool as m,screenshotTool as f,clickTool as h,typeTextTool as E,waitForTool as T,getHtmlTool as v,getConsoleLogsTool as S,evaluateScriptTool as P,listExternalBrowserTabsTool as g,browserSnapshotTool as y}from"./tools/browserTools.js";import{pdfTools as N}from"./tools/pdfTools.js";import{visionTools as C}from"./tools/visionTools.js";import{CapabilityManager as O,createCapabilityManagerFromArgs as b,Capability as I}from"./capabilities/index.js";import{getErrDetails as w}from"./utils/errorUtils.js";export const authHandler=async r=>{const t=r.headers["x-forwarded-for"]?.split(",")[0].trim()||r.socket?.remoteAddress||"unknown",s=o.child({clientIp:t,op:"auth"}),a={id:e(),type:"None",authenticatedAt:Date.now(),clientIp:t,"~standard":{parameters:{},context:{}}};return s.info({authId:a.id},"Authentification dÃ©sactivÃ©e."),a};export async function applicationEntryPoint(){o.info(`DÃ©marrage du serveur en mode ${t.NODE_ENV}...`);const e=new O,R=process.argv.slice(2),x=b(R),D=x.getEnabledCapabilities().length>0?x:e,j=new r({name:"MCP-Server-Production",version:"2.1.0",authenticate:authHandler,instructions:"Serveur MCP amÃ©liorÃ© avec catÃ©gories d'outils et capacitÃ©s modulaires. Support PDF, Vision, Performance, RÃ©seau. Transport HTTP Stream.",health:{enabled:!0,path:t.HEALTH_CHECK_PATH,message:"Server is healthy and ready."},ping:{enabled:!0,intervalMs:15e3,logLevel:t.LOG_LEVEL||"info"},roots:{enabled:!1}}),A=[s,a,i,n,c,l,p,d,u,m,f,h,E,T,v,S,P,g,y];A.forEach(e=>j.addTool(e));const H=[...A];D.isCapabilityEnabled(I.PDF)&&(N.forEach(e=>{j.addTool(e)}),H.push(...N),o.info("CapacitÃ© PDF activÃ©e - Outils PDF enregistrÃ©s")),D.isCapabilityEnabled(I.VISION)&&(C.forEach(e=>j.addTool(e)),H.push(...C),o.info("CapacitÃ© Vision activÃ©e - Outils de vision enregistrÃ©s"));const M=H;o.info({tools:M.map(e=>e.name),totalTools:M.length},"Outils enregistrÃ©s avec succÃ¨s."),j.on("connect",e=>{o.info("Nouvelle session client Ã©tablie.")}),j.on("disconnect",e=>{o.warn({reason:e.reason||"Non spÃ©cifiÃ©e"},"Session client dÃ©connectÃ©e.")});try{await j.start({transportType:"httpStream",httpStream:{port:t.PORT,endpoint:"/mcp"}}),o.info(`ðŸš€ Serveur FastMCP dÃ©marrÃ© en mode HTTP Stream par dÃ©faut sur http://localhost:${t.PORT}/mcp (SSE: /sse)`)}catch(e){o.fatal({err:w(e)},"Ã‰chec critique lors du dÃ©marrage du serveur."),process.exit(1)}const F=async e=>{o.warn(`Signal ${e} reÃ§u. ArrÃªt propre du serveur...`);try{await j.stop(),o.info("Serveur FastMCP arrÃªtÃ© avec succÃ¨s.")}catch(e){o.error({err:w(e)},"Erreur lors de l'arrÃªt du serveur.")}finally{process.exit(0)}};process.on("SIGTERM",()=>F("SIGTERM")),process.on("SIGINT",()=>F("SIGINT"))}process.on("uncaughtException",(e,r)=>{o.fatal({err:w(e),origin:r},"EXCEPTION NON CAPTURÃ‰E. ArrÃªt forcÃ©."),"test"!==t.NODE_ENV&&process.exit(1)}),process.on("unhandledRejection",e=>{o.error({reason:w(e)},"REJET DE PROMESSE NON GÃ‰RÃ‰.")}),applicationEntryPoint();