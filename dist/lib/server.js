import{randomUUID as o}from"crypto";import{FastMCP as e}from"fastmcp";import{config as r}from"./config.js";import t from"./logger.js";import{launchBrowserTool as a,listBrowsersTool as n,detectOpenBrowsersTool as s,connectExternalBrowserTool as d,closeBrowserTool as i,listTabsTool as c,selectTabTool as l,newTabTool as p,closeTabTool as u,navigateTool as T,screenshotTool as m,clickTool as h,typeTextTool as f,waitForTool as E,getHtmlTool as S,getConsoleLogsTool as v,evaluateScriptTool as y,listExternalBrowserTabsTool as P,browserSnapshotTool as N}from"./tools/browserTools.js";import{getErrDetails as g}from"./utils/errorUtils.js";export const authHandler=async e=>{const r=e.headers["x-forwarded-for"]?.split(",")[0].trim()||e.socket?.remoteAddress||"unknown",a=t.child({clientIp:r,op:"auth"}),n={id:o(),type:"None",authenticatedAt:Date.now(),clientIp:r,"~standard":{parameters:{},context:{}}};return a.info({authId:n.id},"Authentification dÃ©sactivÃ©e."),n};export async function applicationEntryPoint(){t.info(`DÃ©marrage du serveur en mode ${r.NODE_ENV}...`);const o=new e({name:"MCP-Server-Production",version:"2.0.0",authenticate:authHandler,instructions:"Serveur MCP pour opÃ©rations synchrones et asynchrones. Le transport est HTTP Stream. L'authentification Bearer est requise.",health:{enabled:!0,path:r.HEALTH_CHECK_PATH,message:"Server is healthy and ready."},ping:{enabled:!0,intervalMs:15e3,logLevel:r.LOG_LEVEL||"info"},roots:{enabled:!1}});o.addTool(a),o.addTool(n),o.addTool(s),o.addTool(d),o.addTool(i),o.addTool(c),o.addTool(l),o.addTool(p),o.addTool(u),o.addTool(T),o.addTool(m),o.addTool(h),o.addTool(f),o.addTool(E),o.addTool(S),o.addTool(v),o.addTool(y),o.addTool(P),o.addTool(N);const I=[a,n,s,d,i,c,l,p,u,T,m,h,f,E,S,v,y,P,N];t.info({tools:I.map(o=>o.name),totalTools:I.length},"Outils enregistrÃ©s avec succÃ¨s."),o.on("connect",o=>{t.info("Nouvelle session client Ã©tablie.")}),o.on("disconnect",o=>{t.warn({reason:o.reason||"Non spÃ©cifiÃ©e"},"Session client dÃ©connectÃ©e.")});try{await o.start({transportType:"httpStream",httpStream:{port:r.PORT,endpoint:"/mcp"}}),t.info(`ðŸš€ Serveur FastMCP dÃ©marrÃ© en mode HTTP Stream par dÃ©faut sur http://localhost:${r.PORT}/mcp (SSE: /sse)`)}catch(o){t.fatal({err:g(o)},"Ã‰chec critique lors du dÃ©marrage du serveur."),process.exit(1)}const O=async e=>{t.warn(`Signal ${e} reÃ§u. ArrÃªt propre du serveur...`);try{await o.stop(),t.info("Serveur FastMCP arrÃªtÃ© avec succÃ¨s.")}catch(o){t.error({err:g(o)},"Erreur lors de l'arrÃªt du serveur.")}finally{process.exit(0)}};process.on("SIGTERM",()=>O("SIGTERM")),process.on("SIGINT",()=>O("SIGINT"))}process.on("uncaughtException",(o,e)=>{t.fatal({err:g(o),origin:e},"EXCEPTION NON CAPTURÃ‰E. ArrÃªt forcÃ©."),"test"!==r.NODE_ENV&&process.exit(1)}),process.on("unhandledRejection",o=>{t.error({reason:g(o)},"REJET DE PROMESSE NON GÃ‰RÃ‰.")}),applicationEntryPoint();